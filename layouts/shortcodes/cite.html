<span class="{{ if len .Params | eq 2 }}{{ .Get 1 }}{{ else }}citation{{ end }}">
  {{ $key := .Get 0 }}
  {{ $posts := where $.Site.RegularPages "Params.paper_key" $key}}
  {{ if $posts }}
    {{ $post := index $posts 0 }}
    <a href="{{ $post.URL }}">{{ $post.Params.linktitle | default $post.Params.title | htmlEscape }}</a>
  {{ else }}
    {{ $bib :=  $.Site.Data.bibliography.references}}
    {{ $entries := where $bib "id" $key }}
    {{ if $entries }}
      {{ $entry := index $entries 0 }}
      {{ $year := (index $entry.issued 0).year }}
      <span class="citation-title">{{ $entry.title | htmlEscape }}</span>, 
      <span class="citation-authors">
        {{ range $i, $author := $entry.author }}
          {{ $full := printf "%s %s" $author.given $author.family }}
          {{ $fullrev := printf "%s, %s" $author.family $author.given }}
          {{ $abbrev := delimit (slice $author.family (substr $author.given 0 1)) ", "}}
          {{/*Retrieve all paper entries in Data for which there is a post */}}
          {{ $.Scratch.Set "keys" slice }}
          {{ range $k := $.Site.RegularPages }}
            {{ $.Scratch.Add "keys" $k.Params.paper_key }}
          {{ end }}
          {{ with $papersWithPost := where $bib "id" "in" ($.Scratch.Get "keys") }}
            {{/* (index $papersWithPost 0).author is an array of author maps*/}}
            {{ $.Scratch.Set "flag" false }}
            {{ range $p := $papersWithPost }}
              {{ with $matches := where (where $p.author "family" $author.family) "given" $author.given }}
                {{ $.Scratch.Set "flag" true}}
              {{ end }}
            {{end}}
            {{ if $.Scratch.Get "flag" }}
              <a href="{{ $.Site.BaseURL }}paper_authors/{{ print $fullrev | urlize }}">{{ $abbrev | htmlEscape }}.</a>
            {{ else }}
              {{ $abbrev | htmlEscape }}.
            {{ end }}
          {{end}}
          {{ if lt $i (sub (len $entry.author) 1)}}, {{end}}
        {{ end }}
      </span>
      <span class="citation-date">({{ $year }})</span>
    {{ else }} 
      <strong>Wrong citekey: {{ $key }}</strong>
    {{ end }}
  {{ end }}
</span>
